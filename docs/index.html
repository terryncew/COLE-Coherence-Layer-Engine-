<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Receipt · Nano Viewer</title>
<style>
  :root{--bg:#fff;--ink:#0b0b10;--muted:#6a6f7a;--line:#e9ecf2;--ok:#16a34a;--am:#f59e0b;--rd:#ef4444}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 -apple-system,system-ui,Segoe UI,Inter,Helvetica,Arial}
  .wrap{max-width:720px;margin:0 auto;padding:14px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chip{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:999px;padding:8px 12px}
  .dot{width:9px;height:9px;border-radius:50%}
  .k{background:var(--ok)} .a{background:var(--am)} .r{background:var(--rd)} .w{background:#9aa3b2}
  .card{margin-top:10px;border:1px solid var(--line);border-radius:12px;padding:12px}
  .kv{display:grid;grid-template-columns:1fr auto;gap:8px 10px}
  .muted{color:var(--muted);font-size:12px}
  .btn{margin-left:auto;border:1px solid var(--line);padding:8px 12px;border-radius:10px;text-decoration:none;color:inherit}
  .bar{position:relative;height:10px;border-radius:999px;background:#f5f7fb;border:1px solid var(--line);overflow:hidden}
  .fill{position:absolute;left:0;top:0;bottom:0;background:#0b0b10;opacity:.9}
  .meta{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
  code{font:12px ui-monospace,Menlo,Consolas,monospace;background:#f6f7fb;border:1px solid var(--line);border-radius:7px;padding:2px 6px}
</style>
<div class="wrap">
  <div class="row" id="head">
    <div class="chip"><span class="dot w" id="dot"></span><b id="status">—</b></div>
    <div class="muted" id="ts">—</div>
    <a class="btn" id="dl" href="#" download>Download JSON</a>
  </div>

  <div class="card">
    <div class="kv">
      <div>κ</div><div id="k">—</div>
      <div class="bar"><div id="kfill" class="fill" style="width:0%"></div></div><div class="muted">≤ .75</div>

      <div>Δhol</div><div id="d">—</div>
      <div class="bar"><div id="dfill" class="fill" style="width:0%"></div></div><div class="muted">≤ .35</div>
    </div>
    <div class="meta">
      <div class="muted">Bytes: <span id="bytes">—</span></div>
      <div class="muted">ctr: <span id="ctr">—</span></div>
      <div class="muted">nx: <code id="nx">—</code></div>
    </div>
  </div>
</div>

<script>
(async()=>{
  const qs = s=>document.querySelector(s);
  const cand = [
    './docs/receipt.latest.json',
    './receipt.latest.json',
    (()=>{
      const p = location.pathname.split('/').filter(Boolean);
      const repo = p[0]; const user = location.hostname.split('.')[0];
      return `https://raw.githubusercontent.com/${user}/${repo}/main/docs/receipt.latest.json`;
    })()
  ];
  async function fetchText(u){
    try{ const r=await fetch(u+'?v='+Date.now(),{cache:'no-store'}); if(!r.ok) return null; const t=await r.text(); return {t, u}; }catch{ return null; }
  }
  let got=null; for(const u of cand){ got = await fetchText(u); if(got) break; }
  if(!got){ qs('#status').textContent='NO RECEIPT'; return; }

  const bytes = new TextEncoder().encode(got.t).length;
  const j = JSON.parse(got.t);

  // compatibility paths
  const status = String(j.attrs?.status || j.status || 'white').toLowerCase();
  const k      = Number(j.signals?.kappa ?? j.telem?.kappa_eff ?? j.openline_frame?.telem?.kappa_eff ?? 0);
  const dhol   = Number(j.signals?.dhol ?? j.signals?.delta_hol ?? j.telem?.delta_hol ?? j.openline_frame?.telem?.delta_hol ?? 0);
  const ts     = j.attrs?.ts || j.attest?.sign_time || new Date().toISOString();
  const ctr    = j.ctr ?? j.digest?.depth ?? j.openline_frame?.digest?.depth ?? null;
  const nx     = Array.isArray(j.nx)? j.nx.map(([k,v])=>k+':'+v).join(',') : (j.next_try?.patch? 'patch' : '—');

  const color = status==='red'?'r':status==='amber'?'a':status==='green'?'k':'w';
  qs('#dot').className='dot '+color;
  qs('#status').textContent=status.toUpperCase();
  qs('#ts').textContent=new Date(ts).toLocaleString();
  qs('#dl').href=got.u;
  qs('#bytes').textContent=bytes;
  qs('#ctr').textContent=ctr??'—';
  qs('#nx').textContent=nx;

  const capK=.75, capD=.35;
  const pct = (v,cap)=>Math.max(0,Math.min(1,(+v||0)/cap))*100;
  qs('#k').textContent=Number.isFinite(k)?k.toFixed(3):'—';
  qs('#d').textContent=Number.isFinite(dhol)?dhol.toFixed(3):'—';
  qs('#kfill').style.width = pct(k,capK).toFixed(1)+'%';
  qs('#dfill').style.width = pct(dhol,capD).toFixed(1)+'%';
})();
</script>
