<!doctype html><meta charset="utf-8">
<title>COLE — Coherence Layer Engine</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
  :root{--bg:#fafafa;--card:#fff;--muted:#6a6a6a;--ok:#0a0;--warn:#c80;--bad:#c00;--line:#eee}
  body{font:16px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif;margin:28px;background:var(--bg)}
  h1{font-size:28px;margin:0 0 6px}
  p.lead{color:#555;margin:0 0 18px;max-width:60ch}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .tile{flex:1 1 360px;padding:14px;border:1px solid var(--line);border-radius:12px;background:var(--card)}
  .muted{color:var(--muted)} .small{font-size:13px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-size:13px}
  .dot{width:8px;height:8px;border-radius:50%}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  code{background:#f3f3f3;padding:2px 6px;border-radius:6px}
  .hint{margin-top:8px;padding:10px;border-radius:10px;background:#f7fbff;border:1px solid #e5f0ff}
  .kv{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
  .kv span{background:#f5f5f5;border:1px solid #eee;border-radius:8px;padding:4px 8px}
  .err{padding:10px;border-radius:10px;background:#fff3f3;border:1px solid #ffd0d0}
</style>

<!-- Load OpenLine card only after we confirm JSON exists -->
<script type="module" src="https://cdn.jsdelivr.net/gh/terryncew/openline-core@main/receipts-kit/openline-card.js"></script>

<h1>Engine</h1>
<p class="lead">
  Three experts (Id / Ego / Superego) each propose a move; COLE blends them in real time.
  We reward φ* (coherence-per-cost) and penalize κ (curvature/jerk) and ε (noise).
  Each run emits a one-card OpenLine receipt.
</p>

<div class="row">
  <div class="tile">
    <!-- Status -->
    <div class="pill" id="statusPill" hidden>
      <span class="dot" id="statusDot"></span>
      <span id="statusText">status</span>
    </div>

    <div class="muted" style="margin:10px 0 6px">Latest receipt</div>
    <!-- Replaced by card after JSON check -->
    <div id="cardBox" class="muted">Loading…</div>

    <!-- Why / Fix (plain English, one line each) -->
    <div class="hint small" id="whyBox" hidden><b>Why not green:</b> <span id="whyText"></span></div>
    <div class="hint small" id="fixBox" hidden><b>Try next:</b> <span id="fixText"></span></div>

    <!-- Optional patch from receipt.next_try.patch -->
    <div class="hint small" id="patchBox" hidden>
      <b>Suggested patch</b> (auto-applied on next run): <code id="patchText"></code>
    </div>

    <!-- One-glance telemetry -->
    <div class="kv small" id="glance" hidden>
      <span>gain <b id="g-gain"></b></span>
      <span>Δ_scale <b id="g-delta"></b></span>
      <span>threshold <b id="g-thresh"></b></span>
      <span>steps <b id="g-steps"></b></span>
      <span>n <b id="g-n"></b></span>
    </div>

    <p class="small muted" style="margin-top:10px">
      Source: <a href="./receipt.latest.json"><code>docs/receipt.latest.json</code></a>
    </p>
  </div>

  <div class="tile">
    <div class="muted" style="margin-bottom:8px">Run it again</div>
    <ol class="small" style="margin:0 0 10px 18px">
      <li>GitHub → <b>Actions</b> → <i>Emit receipt (COLE telem)</i></li>
      <li>Tap <b>Run workflow</b></li>
      <li>Refresh this page</li>
    </ol>
    <p class="small muted">Green = invariants satisfied. Amber/Red = the pill explains the exact miss and the fix.</p>
    <p class="small"><a id="lnk-log" href="./tuning.log.jsonl">Tuning log</a> · <a id="lnk-prop" href="./proposals.latest.json">Proposed patch</a></p>
  </div>
</div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const pill=$('statusPill'), dot=$('statusDot'), txt=$('statusText');
  const whyBox=$('whyBox'), whyText=$('whyText');
  const fixBox=$('fixBox'), fixText=$('fixText');
  const patchBox=$('patchBox'), patchText=$('patchText');
  const gl=$('glance'), cardBox=$('cardBox');

  const color = s => (s==='green'?'ok':(s==='amber'?'warn':'bad'));
  const dotColor = s => ({green:'#0a0', amber:'#c80', red:'#c00'}[s]||'#bbb');

  // cache-bust so Safari/iOS won’t hold a stale 404
  const url = new URL('receipt.latest.json', location.href);
  url.searchParams.set('v', Date.now().toString());

  fetch(url,{cache:'no-store'})
    .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
    .then(j=>{
      // Insert the card once JSON exists
      const card=document.createElement('openline-card');
      card.setAttribute('mode','compact');
      card.setAttribute('src', url.pathname + url.search);
      cardBox.replaceChildren(card);

      const t = j.telem || {};
      const gain   = Number(t.regen_gain || 0);
      const drift  = Number(t.delta_scale || 0);
      const thresh = Number(j.threshold ?? 0.15);

      // ONE ground truth: derive status from telemetry (so card and pill always match)
      const s = (gain <= 0.02) ? 'red' : ((gain >= 0.20 && drift <= thresh) ? 'green' : 'amber');

      // Status pill
      txt.textContent = s;
      dot.style.background = dotColor(s);
      pill.className = 'pill ' + color(s);
      pill.hidden = false;

      // Why (single crisp reason)
      let why = Array.isArray(j.but) && j.but[0] ? j.but[0] : '';
      if (!why) {
        if (drift > thresh) why = `drift Δ_scale ${drift.toFixed(3)} > threshold ${thresh.toFixed(3)}`;
        else if (gain <= 0.02) why = 'no meaningful gain';
        else if (gain < 0.20)  why = `low gain ${gain.toFixed(3)}`;
      }
      if (s!=='green' && why){ whyText.textContent = why; whyBox.hidden = false; }

      // Fix (from receipt or generic)
      let fix = (typeof j.so === 'string' && j.so.trim()) ? j.so.trim() : '';
      if (!fix) {
        if (drift > thresh) fix = 'increase smoothing/coarse or reduce pull; add steps if edges are oversharp';
        else if (gain < 0.20) fix = 'bump steps or lower noise; check blend weights';
      }
      if (s!=='green' && fix){ fixText.textContent = fix; fixBox.hidden = false; }

      // Optional patch display
      if (j.next_try && Array.isArray(j.next_try.patch)) {
        patchText.textContent = j.next_try.patch.map(p => `${p.key}→${p.to}`).join(' · ');
        patchBox.hidden = false;
      }

      // Glance telemetry
      $('g-gain').textContent   = gain.toFixed(3);
      $('g-delta').textContent  = drift.toFixed(3);
      $('g-thresh').textContent = thresh.toFixed(3);
      $('g-steps').textContent  = Number(t.steps || 0);
      $('g-n').textContent      = Number(t.n || 0);
      gl.hidden = false;
    })
    .catch(err=>{
      cardBox.innerHTML =
        `<div class="err"><b>No JSON found</b> at <code>${url.pathname}</code> (${err.message}).
          Run <i>Actions → Emit receipt (COLE telem)</i> or check the file path.</div>`;
    });

  // Hide optional links if missing
  async function hideIfMissing(id, path){
    try{ const r = await fetch(path,{method:'HEAD',cache:'no-store'}); if(!r.ok) $(id).style.display='none'; }
    catch{ $(id).style.display='none'; }
  }
  hideIfMissing('lnk-log','./tuning.log.jsonl');
  hideIfMissing('lnk-prop','./proposals.latest.json');
})();
</script>
