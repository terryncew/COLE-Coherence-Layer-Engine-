<!doctype html><meta charset="utf-8">
<title>COLE — Coherence Layer Engine</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
  :root{--bg:#fafafa;--card:#fff;--muted:#6a6a6a;--ok:#0a0;--warn:#c80;--bad:#c00;--line:#eee}
  body{font:16px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif;margin:28px;background:var(--bg)}
  h1{font-size:28px;margin:0 0 6px}
  p.lead{color:#555;margin:0 0 18px;max-width:60ch}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .tile{flex:1 1 360px;padding:14px;border:1px solid var(--line);border-radius:12px;background:var(--card)}
  .muted{color:var(--muted)} .small{font-size:13px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-size:13px}
  .dot{width:8px;height:8px;border-radius:50%}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  code{background:#f3f3f3;padding:2px 6px;border-radius:6px}
  .hint{margin-top:8px;padding:10px;border-radius:10px;background:#f7fbff;border:1px solid #e5f0ff}
  .kv{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
  .kv span{background:#f5f5f5;border:1px solid #eee;border-radius:8px;padding:4px 8px}
  .err{padding:10px;border-radius:10px;background:#fff3f3;border:1px solid #ffd0d0}
  .tag{padding:.2em .6em;border-radius:6px;color:#fff}
</style>

<!-- OpenLine card (compact) -->
<script type="module" src="https://cdn.jsdelivr.net/gh/terryncew/openline-core@main/receipts-kit/openline-card.js"></script>

<h1>Engine</h1>
<p class="lead">
  Three experts (Id / Ego / Superego) each propose a move; COLE blends them in real time.
  We reward φ* (coherence-per-cost) and penalize κ (curvature/jerk) and ε (noise).
  Each run emits a one-card OpenLine receipt.
</p>

<div class="row">
  <div class="tile">
    <!-- Status -->
    <div class="pill" id="statusPill" hidden>
      <span class="dot" id="statusDot"></span>
      <span id="statusText">status</span>
    </div>

    <div class="muted" style="margin:10px 0 6px">Latest receipt</div>
    <!-- Replaced by card after JSON check -->
    <div id="cardBox" class="muted">Loading…</div>

    <!-- Why / Fix (plain English, one line each) -->
    <div class="hint small" id="whyBox" hidden><b>Why not green:</b> <span id="whyText"></span></div>
    <div class="hint small" id="fixBox" hidden><b>Try next:</b> <span id="fixText"></span></div>

    <!-- Optional patch from receipt.next_try.patch -->
    <div class="hint small" id="patchBox" hidden>
      <b>Suggested patch</b> (auto-applied on next run): <code id="patchText"></code>
    </div>

    <!-- One-glance telemetry -->
    <div class="kv small" id="glance" hidden>
      <span>gain <b id="g-gain"></b></span>
      <span>Δ_scale <b id="g-delta"></b></span>
      <span>threshold <b id="g-thresh"></b></span>
      <span>steps <b id="g-steps"></b></span>
      <span>n <b id="g-n"></b></span>
    </div>

    <p class="small muted" style="margin-top:10px">
      Source: <a href="./receipt.latest.json"><code>docs/receipt.latest.json</code></a>
    </p>
  </div>

  <div class="tile">
    <div class="muted" style="margin-bottom:8px">Run it again</div>
    <ol class="small" style="margin:0 0 10px 18px">
      <li>GitHub → <b>Actions</b> → <i>COLE Pages (guards + status)</i></li>
      <li>Tap <b>Run workflow</b></li>
      <li>Refresh this page</li>
    </ol>
    <p class="small muted">Green = invariants satisfied. Amber/Red = the pill explains the exact miss and the fix.</p>
    <p class="small"><a id="lnk-log" href="./tuning.log.jsonl">Tuning log</a> · <a id="lnk-prop" href="./proposals.latest.json">Proposed patch</a></p>
    <div class="small">Receipt: <b id="verified-tag" class="tag">Pending</b></div>
  </div>

  <!-- Invariants & Topology -->
  <div class="tile" id="inv-topo" hidden>
    <div class="muted" style="margin-bottom:6px">Invariants & Topology</div>
    <div class="small" id="geom-line">geometry: <b id="geom-worst">n/a</b> cap usage</div>
    <div class="small">evolution: inflections <b id="evo-inf">0</b> · flips/epoch <b id="evo-flips">0</b></div>
    <div class="small">defect: <b id="def-class">–</b></div>
    <div class="small">H <b id="H">–</b> · κ <b id="K">–</b> · χ <b id="X">–</b> · ε <b id="E">–</b> · D <b id="D">–</b> · R <b id="R">–</b></div>
  </div>

  <!-- Frontier Watch (shows if your script writes frontier_watch{}) -->
  <div class="tile" id="fw-tile" hidden>
    <div class="muted">Frontier Watch</div>
    <div class="small" id="fwBox">Loading…</div>
  </div>

  <!-- Training evolution (v1.2) -->
  <div class="tile" id="te-tile" hidden>
    <div class="muted">Training evolution</div>
    <div class="small">seed <b id="te-seed">—</b> · lineage <b id="te-len">0</b> · events <b id="te-ev">0</b></div>
    <div class="small">largest jump <b id="te-jump">—</b> · inflections <b id="te-inf">—</b> · ewma slope <b id="te-slope">—</b></div>
    <div class="small">grad ∥ <b id="te-gmean">—</b>±<b id="te-gstd">—</b> (max <b id="te-gmax">—</b>)</div>
    <div class="small">causal hint <b id="te-causal">—</b></div>
  </div>
</div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const pill=$('statusPill'), dot=$('statusDot'), txt=$('statusText');
  const whyBox=$('whyBox'), whyText=$('whyText');
  const fixBox=$('fixBox'), fixText=$('fixText');
  const patchBox=$('patchBox'), patchText=$('patchText');
  const gl=$('glance'), cardBox=$('cardBox');

  const color = s => (s==='green'?'ok':(s==='amber'?'warn':'bad'));
  const dotColor = s => ({green:'#0a0', amber:'#c80', red:'#c00'}[s]||'#bbb');

  // cache-bust
  const url = new URL('receipt.latest.json', location.href);
  url.searchParams.set('v', Date.now().toString());

  fetch(url,{cache:'no-store'})
    .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
    .then(j=>{
      // Insert the card once JSON exists
      const card=document.createElement('openline-card');
      card.setAttribute('mode','compact');
      card.setAttribute('src', url.pathname + url.search);
      cardBox.replaceChildren(card);

      const t = j.telem || {};
      const gain   = Number(t.regen_gain || 0);
      const drift  = Number(t.delta_scale || 0);
      const thresh = Number(j.threshold ?? 0.15);

      // derive status from telemetry (so card and pill match)
      const s = (gain <= 0.02) ? 'red' : ((gain >= 0.20 && drift <= thresh) ? 'green' : 'amber');

      // Status pill
      txt.textContent = s;
      dot.style.background = dotColor(s);
      pill.className = 'pill ' + color(s);
      pill.hidden = false;

      // Why (single crisp reason)
      let why = Array.isArray(j.but) && j.but[0] ? j.but[0] : '';
      if (!why) {
        if (drift > thresh) why = `drift Δ_scale ${drift.toFixed(3)} > threshold ${thresh.toFixed(3)}`;
        else if (gain <= 0.02) why = 'no meaningful gain';
        else if (gain < 0.20)  why = `low gain ${gain.toFixed(3)}`;
      }
      if (s!=='green' && why){ whyText.textContent = why; whyBox.hidden = false; }

      // Fix (from receipt or generic)
      let fix = (typeof j.so === 'string' && j.so.trim()) ? j.so.trim() : '';
      if (!fix) {
        if (drift > thresh) fix = 'increase smoothing/coarse or reduce pull; add steps if edges are oversharp';
        else if (gain < 0.20) fix = 'bump steps or lower noise; check blend weights';
      }
      if (s!=='green' && fix){ fixText.textContent = fix; fixBox.hidden = false; }

      // Optional patch display
      if (j.next_try && Array.isArray(j.next_try.patch)) {
        patchText.textContent = j.next_try.patch.map(p => `${p.key}→${p.to}`).join(' · ');
        patchBox.hidden = false;
      }

      // Glance telemetry
      document.getElementById('g-gain').textContent   = gain.toFixed(3);
      document.getElementById('g-delta').textContent  = drift.toFixed(3);
      document.getElementById('g-thresh').textContent = thresh.toFixed(3);
      document.getElementById('g-steps').textContent  = Number(t.steps || 0);
      document.getElementById('g-n').textContent      = Number(t.n || 0);
      gl.hidden = false;
    })
    .catch(err=>{
      cardBox.innerHTML =
        `<div class="err"><b>No JSON found</b> at <code>${url.pathname}</code> (${err.message}).
          Run <i>Actions → COLE Pages (guards + status)</i> or check the file path.</div>`;
    });

  // Hide optional links if missing
  async function hideIfMissing(id, path){
    try{ const r = await fetch(path,{method:'HEAD',cache:'no-store'}); if(!r.ok) document.getElementById(id).style.display='none'; }
    catch{ document.getElementById(id).style.display='none'; }
  }
  hideIfMissing('lnk-log','./tuning.log.jsonl');
  hideIfMissing('lnk-prop','./proposals.latest.json');
})();
</script>

<!-- Verified tag (works if docs/status.json exists; otherwise stays "Pending") -->
<script>
fetch('./status.json?'+Date.now()).then(r=>r.ok?r.json():null).then(s=>{
  if(!s) return;
  const tag=document.getElementById('verified-tag');
  tag.textContent = s.verified ? 'Verified' : 'Pending';
  tag.style.background = s.verified ? '#065f46' : '#92400e';
}).catch(()=>{});
</script>

<!-- Topology tile -->
<script>
(async()=>{
  try{
    const u = new URL('./receipt.latest.json', location.href);
    u.searchParams.set('v', Date.now().toString()); // cache-bust
    const r = await fetch(u.toString(), {cache:'no-store'});
    if(!r.ok) return;
    const j = await r.json();

    const rows = Array.isArray(j.geometry_attestation)? j.geometry_attestation : [];
    let worst = 0; const caps={spectral_max:2.0,orthogonality_error:0.08,lipschitz_budget_used:0.80};
    for(const row of rows){
      for(const k in caps){
        const v = +row[k]; if(!Number.isFinite(v)) continue;
        worst = Math.max(worst, v / caps[k]);
      }
    }
    const worstStr = (Number.isFinite(worst) && worst>0) ? (worst.toFixed(2)+'×') : 'n/a';
    document.getElementById('geom-worst').textContent = worstStr;

    const evo = j.training_evolution || {};
    const shape = evo.loss_trajectory_shape || {};
    document.getElementById('evo-inf').textContent = +(shape.inflections||0);
    document.getElementById('evo-flips').textContent = +(j.training_evolution?.policy_flips_per_epoch||0);

    const dt = j.defect_topology || {};
    document.getElementById('def-class').textContent = (dt.class||'–');

    const t = j.topo || {};
    const fmt = x => (Number.isFinite(+x)? (+x).toFixed(3) : '–');
    document.getElementById('H').textContent = fmt(t.H);
    document.getElementById('K').textContent = fmt(t.kappa);
    document.getElementById('X').textContent = fmt(t.chi);
    document.getElementById('E').textContent = fmt(t.eps);
    document.getElementById('D').textContent = fmt(t.D_topo);
    document.getElementById('R').textContent = fmt(t.rigidity);

    document.getElementById('inv-topo').hidden = false;
  }catch{}
})();
</script>

<!-- Frontier Watch tile (non-blocking; shows if frontier_watch exists) -->
<script>
(async()=>{
  try{
    const r=await fetch('./receipt.latest.json?'+Date.now()); if(!r.ok) return;
    const j=await r.json(); const fw=j.frontier_watch||{};
    if(!fw || !fw.summary) return;
    const s = Array.isArray(fw.signals)? fw.signals : [];
    const sum = fw.summary || {};
    const top = s.slice().sort((a,b)=>(b.delta_frame||0)-(a.delta_frame||0)).slice(0,2);
    const row = x => `
      <div style="margin-top:6px">
        <b>${(x.title||x.id||'signal')}</b> <span class="muted">— ${(x.source||'')}</span><br/>
        κ=${Number(x.kappa||0).toFixed(2)} · ε=${Number(x.epsilon||0).toFixed(2)} · L=${Number(x.legibility||0).toFixed(2)} · Δ=${Number(x.delta_frame||0).toFixed(2)}
      </div>`;
    document.getElementById('fwBox').innerHTML = s.length
      ? `<div>signals: <b>${sum.count||s.length}</b> · avg novelty <b>${Number(sum.avg_novelty||0).toFixed(2)}</b> · avg constraint <b>${Number(sum.avg_constraint||0).toFixed(2)}</b></div>
         ${top.map(row).join('')}`
      : 'No signals';
    document.getElementById('fw-tile').hidden=false;
  }catch(e){}
})();
</script>

<!-- Training evolution tile (v1.2) -->
<script>
(async()=>{
  try{
    const r=await fetch('./receipt.latest.json?'+Date.now()); if(!r.ok) return;
    const j=await r.json(); const te=j.training_evolution||{};
    const G=(id,v)=>{const e=document.getElementById(id); if(e) e.textContent=v;};
    if(!te.seed && !te.checkpoint_lineage) return;
    G('te-seed', te.seed ?? '—'); G('te-len', (te.checkpoint_lineage||[]).length);
    G('te-ev', (te.capability_events||[]).length);
    const sh=te.loss_trajectory_shape||{};
    G('te-jump', (sh.largest_jump??'—')); G('te-inf', (sh.inflections??'—'));
    G('te-slope', (sh.ewma_slope!=null && !isNaN(sh.ewma_slope)) ? Number(sh.ewma_slope).toFixed(3) : '—');
    const gs=te.grad_norm_stats||{};
    G('te-gmean', (gs.mean??'—')); G('te-gstd', (gs.std??'—')); G('te-gmax', (gs.max??'—'));
    G('te-causal', te.causal_link_hint ? 'true' : 'false');
    document.getElementById('te-tile').hidden=false;
  }catch{}
})();
</script>
