<!doctype html><meta charset="utf-8">
<title>COLE — Coherence Layer Engine</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
  :root{--bg:#fafafa;--card:#fff;--muted:#6a6a6a;--ok:#0a0;--warn:#c80;--bad:#c00;--line:#eee}
  body{font:16px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif;margin:28px;background:var(--bg)}
  h1{font-size:28px;margin:0 0 6px}
  p.lead{color:#555;margin:0 0 18px;max-width:60ch}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .tile{flex:1 1 360px;padding:14px;border:1px solid var(--line);border-radius:12px;background:var(--card)}
  .muted{color:var(--muted)} .small{font-size:13px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-size:13px}
  .dot{width:8px;height:8px;border-radius:50%}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  code{background:#f3f3f3;padding:2px 6px;border-radius:6px}
  .err{padding:10px;border-radius:10px;background:#fff3f3;border:1px solid #ffd0d0}
  .tag{display:inline-block;padding:.2em .6em;border-radius:6px;background:#3f3f46;color:#fff}
</style>

<h1>Engine</h1>
<p class="lead">
  One-click run in Actions builds a frame from the latest answer (text or vision), computes κ and Δhol,
  writes <code>docs/receipt.latest.json</code>, and deploys this page.
</p>

<div class="row">
  <div class="tile">
    <div class="pill" id="statusPill" hidden>
      <span class="dot" id="statusDot"></span><span id="statusText">status</span>
    </div>
    <div class="muted" style="margin:10px 0 6px">Latest receipt</div>
    <div id="cardBox" class="muted">Loading…</div>
    <div class="small muted" style="margin-top:10px">Source:
      <a href="./receipt.latest.json"><code>docs/receipt.latest.json</code></a>
    </div>
  </div>

  <div class="tile">
    <div class="muted">Coherence signals</div>
    <div class="small">κ <b id="kappa">—</b> · Δhol <b id="dhol">—</b> · C <b id="cycles">—</b> · X <b id="xfront">—</b></div>
    <div class="small">status: <span id="statusTag" class="tag">—</span></div>
    <div class="small muted" style="margin-top:8px">Run:
      <ol class="small" style="margin:6px 0 0 18px">
        <li>Actions → <i>COLE Pages (text+vision guard)</i></li>
        <li>Optional: add image URLs (comma-separated)</li>
        <li>Refresh this page</li>
      </ol>
    </div>
  </div>

  <div class="tile">
    <div class="muted">Vision</div>
    <div class="small">images: <b id="imgCount">0</b></div>
    <div class="small muted">If you passed URLs in the workflow, Claude saw them.</div>
  </div>
</div>

<script type="module" src="https://cdn.jsdelivr.net/gh/terryncew/openline-core@main/receipts-kit/openline-card.js"></script>
<script>
(async()=>{
  const $=id=>document.getElementById(id);
  const url=new URL('./receipt.latest.json',location.href); url.searchParams.set('v',Date.now());
  try{
    const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status);
    const j=await r.json();

    // OpenLine card
    const card=document.createElement('openline-card');
    card.setAttribute('mode','compact'); card.setAttribute('src',url.pathname+url.search);
    document.getElementById('cardBox').replaceChildren(card);

    // signals
    const t=((j.temporal||{}).latest)||{}; const n=((j.narrative||{}).continuity)||{};
    const k=+(j.topo?.kappa ?? t.kappa ?? NaN);
    const dh=+(t.delta_hol ?? j.openline_frame?.telem?.delta_hol ?? NaN);
    const C=+(n.cycles_C ?? j.openline_frame?.digest?.cycle_plus ?? 0);
    const X=+(n.contradictions_X ?? j.openline_frame?.digest?.x_frontier ?? 0);
    const fmt=x=>Number.isFinite(x)?x.toFixed(3):'—';
    $('kappa').textContent=fmt(k); $('dhol').textContent=fmt(dh);
    $('cycles').textContent=C; $('xfront').textContent=X;
    $('imgCount').textContent=+(j.vision?.count ?? 0);

    // status tag
    const red = (dh>0.50)||(X>7)||(C>4);
    const amber=(k>0.70)||(X>=3)||(C>=2);
    const tag=$('statusTag'); tag.textContent= red?'BLOCK':(amber?'WARN':'PASS');
    tag.style.background= red?'#7f1d1d':(amber?'#a16207':'#14532d');

    // pill mirrors tag
    const pill=$('statusPill'), dot=$('statusDot'), txt=$('statusText');
    txt.textContent=tag.textContent;
    dot.style.background= red?'#c00':(amber?'#c80':'#0a0');
    pill.hidden=false;
  }catch(e){
    document.getElementById('cardBox').innerHTML =
      `<div class="err"><b>No JSON found</b> at <code>${url.pathname}</code> (${e.message}).</div>`;
  }
})();
</script>
