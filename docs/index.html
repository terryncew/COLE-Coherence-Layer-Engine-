<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>COLE · OpenLine Receipt (OLR/1.4L)</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<style>
  :root{
    --bg:#fafafa; --card:#ffffff; --ink:#0b0b0f; --muted:#6a6a6a; --line:#eaeaea;
    --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626; --chip:#f4f4f5;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:22px}
  h1{font-size:22px;margin:0 0 6px 0}
  .sub{color:var(--muted);font-size:13px;margin:0 0 14px 0}
  .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
  @media (max-width:900px){.grid{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:560px){.grid{grid-template-columns:repeat(2,1fr)}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  .kpi{display:flex;align-items:center;gap:10px}
  .lamp{width:12px;height:12px;border-radius:50%}
  .ok{background:var(--ok)} .warn{background:var(--warn)} .bad{background:var(--bad)} .mutelamp{background:#c7c7cc}
  .big{font-size:20px;font-weight:700}
  .muted{color:var(--muted);font-size:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0 0}
  .btn{background:#111827;color:#fff;border:1px solid #111827;padding:9px 12px;border-radius:10px;text-decoration:none;font-weight:600}
  .btn:active{transform:translateY(1px)}
  .tag{display:inline-block;padding:.25em .6em;border-radius:999px;color:#fff;font-size:12px}
  .tag.green{background:var(--ok)} .tag.amber{background:var(--warn)} .tag.red{background:var(--bad)}
  pre{white-space:pre-wrap;background:#fbfbfc;border:1px solid var(--line);border-radius:10px;padding:10px;overflow:auto}
  .kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px;align-items:center}
  .chip{display:inline-block;background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:.25em .6em;font-size:12px}
  .divider{height:1px;background:var(--line);margin:10px 0}
</style>
</head>
<body>
<div class="wrap">
  <h1>COLE · OpenLine Receipt</h1>
  <div class="sub">Lean 1.4L · “Receipts, not rhetoric.” This reads <code>docs/receipt.latest.json</code> and <code>docs/guard.14l.json</code>.</div>

  <div class="grid" id="grid">
    <!-- KPI tiles injected by JS -->
  </div>

  <div class="row">
    <a class="btn" href="./receipt.latest.json" download>Download receipt</a>
    <a class="btn" href="./history/" id="histLink">History</a>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="kv">
      <div class="muted">Updated</div><div id="updated">—</div>
      <div class="muted">Status</div><div id="status"><span class="tag">—</span></div>
      <div class="muted">Why</div><div id="why">—</div>
      <div class="muted">Try next</div><div id="fix">—</div>
    </div>
    <div class="divider"></div>
    <div class="muted" id="rules">Rules: RED if cycle⁺>0, or (Δhol≥τ_hol & del_suspect), or (κ≥τ_k & UCR≥ucr_min & ES<es_min). AMBER if any one is high.</div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="muted">Frame digest</div>
    <pre id="digest">Loading…</pre>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="muted">Raw telemetry</div>
    <pre id="telem">Loading…</pre>
  </div>
</div>

<script>
(async function(){
  const $ = (id)=>document.getElementById(id);
  const grid = $('grid');

  const cfgDefault = { tau_k:0.75, tau_hol:0.35, ucr_min:0.40, es_min:0.25 };
  let cfg = cfgDefault;

  try{
    const cr = await fetch('./guard.14l.json?ts='+Date.now());
    if(cr.ok){ cfg = {...cfgDefault, ...(await cr.json())}; }
  }catch{}

  function lamp(cls){ const d=document.createElement('div'); d.className='lamp '+cls; return d; }
  function tile(label, value, hint, cls){
    const c=document.createElement('div'); c.className='card';
    const row=document.createElement('div'); row.className='kpi';
    row.appendChild(lamp(cls||'mutelamp'));
    const b=document.createElement('div'); b.className='big'; b.textContent=value;
    row.appendChild(b);
    const cap=document.createElement('div');
    cap.innerHTML = `<div class="muted">${label}</div><div class="muted" style="font-size:11px">${hint||''}</div>`;
    c.appendChild(row); c.appendChild(cap); return c;
  }
  const cK = k => (k>=0.85?'bad':(k>=0.70?'warn':'ok'));
  const cD = d => (d>=cfg.tau_hol?'warn':'ok');

  let rec = null;
  try{
    const r = await fetch('./receipt.latest.json?ts='+Date.now());
    rec = await r.json();
  }catch(e){}
  if(!rec){
    grid.appendChild(tile('No receipt found', '—', 'Run your Pages workflow', 'warn'));
    $('digest').textContent = 'Missing docs/receipt.latest.json';
    $('telem').textContent = '—';
    return;
  }

  // grab fields (lean 1.4L)
  const frame = rec.openline_frame || {};
  const digest = frame.digest || {};
  const telem  = frame.telem || {};
  const latest = (rec.temporal && rec.temporal.latest) || {};

  const k = Number.isFinite(latest.kappa) ? latest.kappa : (telem.kappa_eff ?? NaN);
  const dhol = Number.isFinite(latest.delta_hol) ? latest.delta_hol : (telem.delta_hol ?? NaN);
  const ucr = digest.ucr ?? NaN;
  const es  = telem.evidence_strength ?? NaN;
  const cycles = digest.cycle_plus ?? 0;
  const xfront = digest.x_frontier ?? 0;
  const depth = digest.depth ?? 0;
  const soc = digest.s_over_c ?? NaN;
  const delSus = !!telem.del_suspect;
  const tokens = telem.cost_tokens ?? NaN;

  // compute status if missing
  function computeStatus(){
    if (cycles>0) return 'red';
    const red = ( (dhol>=cfg.tau_hol && delSus) ||
                  (k>=cfg.tau_k && ucr>=cfg.ucr_min && es<cfg.es_min) );
    if (red) return 'red';
    const amber = (k>=cfg.tau_k) || (dhol>=cfg.tau_hol) || (ucr>=cfg.ucr_min);
    return amber ? 'amber' : 'green';
  }
  const status = (rec.status || '').toLowerCase() || computeStatus();

  // KPIs
  grid.appendChild(tile('κ (stress)', isFinite(k)? k.toFixed(3):'—', 'Density vs structure', cK(k)));
  grid.appendChild(tile('Δhol (drift)', isFinite(dhol)? dhol.toFixed(3):'—', 'Path mismatch (EWMA JSD)', cD(dhol)));
  grid.appendChild(tile('UCR', isFinite(ucr)? (ucr*100).toFixed(0)+'%':'—', 'Unsupported-claim ratio', (ucr>=cfg.ucr_min?'warn':'ok')));
  grid.appendChild(tile('ES', isFinite(es)? (es*100).toFixed(0)+'%':'—', 'Evidence strength', (es<cfg.es_min?'warn':'ok')));
  grid.appendChild(tile('Cycles', String(cycles), 'cycle⁺ > 0 → RED', (cycles>0?'bad':'ok')));
  grid.appendChild(tile('X (contradictions)', String(xfront), 'Unresolved contradictions', (xfront>0?'warn':'ok')));

  // status strip
  const sTag = document.createElement('span');
  sTag.className = 'tag '+status;
  sTag.textContent = status.toUpperCase();
  $('status').replaceChildren(sTag);
  $('updated').textContent = new Date((frame.t_logical||Date.now())*1000).toLocaleString();

  // why & fix
  let why='—', fix='—';
  if (cycles>0){ why='Circular reasoning detected (cycle⁺>0)'; fix='Break the loop; add external evidence or restructure claims.'; }
  else if (dhol>=cfg.tau_hol && delSus){ why='Path drift with potential silent deletion'; fix='Add a resolution/handling sentence for removed contradictions.'; }
  else if (k>=cfg.tau_k && ucr>=cfg.ucr_min && es<cfg.es_min){ why='High stress + unsupported claims + weak evidence'; fix='Add citations or “according to…” lines near claims.'; }
  else if (k>=cfg.tau_k){ why='Elevated stress (κ high)'; fix='Shorten or add structure/support so S* rises.'; }
  else if (dhol>=cfg.tau_hol){ why='Path drift (Δhol high)'; fix='Stabilize reasoning across turns; avoid rewriting without resolution.'; }
  else if (ucr>=cfg.ucr_min){ why='Many claims lack nearby support'; fix='Place an evidence sentence or citation within ±1 sentence.'; }

  $('why').textContent = why;
  $('fix').textContent = fix;

  // rules text with thresholds
  $('rules').textContent =
    `Rules: RED if cycle⁺>0, or (Δhol≥${cfg.tau_hol} & del_suspect), or (κ≥${cfg.tau_k} & UCR≥${cfg.ucr_min} & ES<${cfg.es_min}). AMBER if any one is high.`;

  // raw blocks
  $('digest').textContent = JSON.stringify(digest, null, 2);
  $('telem').textContent  = JSON.stringify(telem,  null, 2);

  // small extras
  if (!isFinite(soc) && xfront===0) {
    // keep the tile tidy; not critical to show s/c if X=0
  }
})();
</script>
</body>
</html>
